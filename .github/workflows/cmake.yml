name: Activity Framework build

on:
  push:
    branches: [ "master" , "Release-**" , "Test"]
  pull_request:
    types: [opened, reopened]
    branches: [ "master" , "Release-**"]
  release:
    types: [published]

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release

jobs:
  Linux_x64:
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4

    - name: Configure CMake
      # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
      # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

    - name: Build
      # Build your program with the given configuration
      run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}

    - name: Upload Linux build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: ${{ github.workspace }}/build

    - name: Test
      working-directory: ${{github.workspace}}/build
      # Execute tests defined by the CMake configuration.
      # See https://cmake.org/cmake/help/latest/manual/ctest.1.html for more detail
      run: ${{github.workspace}}/build/Test/ActivityFrameworkTest

  Windows_x64:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Configure CMake (MSVC)
      run: >
        cmake -S . -B ${{github.workspace}}/build-windows
        -G "Visual Studio 17 2022"
        -A x64

    - name: Build (Windows)
      run: cmake --build ${{github.workspace}}/build-windows --config ${{env.BUILD_TYPE}} -- /m

    - name: Upload Windows build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: ${{ github.workspace }}/build-windows

    - name: Test (ctest)
      working-directory: ${{github.workspace}}/build-windows
      run: ctest -C ${{env.BUILD_TYPE}} --output-on-failure

  Android_x86_64:
    runs-on: ubuntu-24.04

    env:
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
      ANDROID_NDK_VERSION: 27.0.12077973     # change if your project needs a specific NDK
      ANDROID_API_LEVEL: 24                  # match your minSdkVersion / project requirement
      ANDROID_ABI: x86_64               # build & run tests on emulator (x86_64)

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Java (required by Android SDK tools)
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    - name: Install required packages
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build unzip curl

    - name: Download Android commandline-tools
      run: |
        mkdir -p "$ANDROID_SDK_ROOT"
        cd "$ANDROID_SDK_ROOT"
        curl -L -o commandlinetools.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools.zip
        mkdir -p cmdline-tools/latest
        mv cmdline-tools/* cmdline-tools/latest/ || true

    - name: Put sdkmanager/avdmanager on PATH
      run: |
        echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH

    - name: Install SDK tools, platforms, and NDK
      env:
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
      run: |
        yes | sdkmanager --licenses
        yes | sdkmanager \
          "platform-tools" \
          "platforms;android-${ANDROID_API_LEVEL}" \
          "build-tools;34.0.0" \
          "emulator" \
          "system-images;android-${ANDROID_API_LEVEL};default;${ANDROID_ABI}" \
          "ndk;${ANDROID_NDK_VERSION}"

    - name: Set up NDK env
      run: |
        echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/${ANDROID_NDK_VERSION}" >> $GITHUB_ENV
        echo "PATH=$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/emulator:$PATH" >> $GITHUB_ENV

    - name: Configure CMake (Android)
      run: |
        cmake -S . -B ${{ github.workspace }}/build-android \
          -G Ninja \
          -DCMAKE_SYSTEM_NAME=Android \
          -DCMAKE_SYSTEM_VERSION=$ANDROID_API_LEVEL \
          -DCMAKE_ANDROID_ARCH_ABI=$ANDROID_ABI \
          -DCMAKE_ANDROID_NDK=$ANDROID_NDK_ROOT \
          -DCMAKE_ANDROID_STL_TYPE=c++_static \
          -DCMAKE_BUILD_TYPE=${BUILD_TYPE}

    - name: Build (Android)
      run: cmake --build ${{ github.workspace }}/build-android --config ${{ env.BUILD_TYPE }} -- -v

    - name: Upload Android build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-build
        path: ${{ github.workspace }}/build-android

    # - name: Enable KVM (for faster x86_64 emulator)
    #   run: |
    #     echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
    #     sudo udevadm control --reload-rules
    #     sudo udevadm trigger --name-match=kvm

    # - name: Run Android x86_64 tests (emulator)
    #   uses: reactivecircus/android-emulator-runner@v2
    #   with:
    #     api-level: 24
    #     arch: x86_64
    #     target: default
    #     profile: Nexus 5X
    #     disk-size: 8192M
    #     emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -no-metrics
    #     cores: 2
    #     avd-name: test
    #     force-avd-creation: true
    #     emulator-boot-timeout: 600
    #     disable-animations: true

    #     script: |
    #       set -euxo pipefail
    #       adb shell getprop ro.product.cpu.abi

    #       TEST_BIN="${GITHUB_WORKSPACE}/build-android/Test/ActivityFrameworkTest"
    #       if [ ! -f "$TEST_BIN" ]; then
    #         echo "Test binary not found at: $TEST_BIN"
    #         echo "Available files under build-android/Test:"; ls -la "${GITHUB_WORKSPACE}/build-android/Test" || true
    #         exit 1
    #       fi

    #       adb push "$TEST_BIN" /data/local/tmp/ActivityFrameworkTest
    #       adb shell chmod +x /data/local/tmp/ActivityFrameworkTest
    #       adb shell /data/local/tmp/ActivityFrameworkTest
